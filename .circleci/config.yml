---
version: 2.1

workflows:
  version: 2
  validate_test_deploy:
    jobs:
      - validate_cm:
          filters:
            branches: 
              ignore: ["prod_cloud"]
      - validate_iac:
          filters:
            branches: 
              ignore: ["prod_cloud"]
      - deploy_iac:
          filters:
            branches:
              only: ["prod_cloud"]
      - deploy_cm:
          requires:
            - deploy_iac
          filters:
            branches:
              only: ["prod_cloud"]

executors:  
  ansible:
    docker:
      - image: "quay.io/ansible/molecule:2.22"
  terraform:
    docker: 
      - image: "hashicorp/terraform:light"

jobs:
  validate_cm:
    executor: ansible
    parameters:
      working_directory: 
        description: working directory
        type: string
        default: ~/
      inventory:
        description: define inventory
        type: string
        default: inventory
      playbook: 
        description: define playbook
        type: string
        default: main.yml
    working_directory: << parameters.working_directory >>
    steps:
      - checkout
      - run:
          name: "YAMl Linting"
          command: yamllint .
      - run:
          name: "Ansible Linting"
          command: ansible-lint << parameters.playbook >>
      - run:
          name: "Ansible Syntax Check"
          command: ansible-playbook -i << parameters.inventory >> << parameters.playbook >> --syntax-check

  validate_iac:
    executor: terraform
    working_directory: ./iac
    steps:
      - checkout
      - run:
          name: "terraform init"
          command: terraform init
      - run:
          name: "terraform validate"
          command: terraform validate
      - run:
          name: "terraform plan"
          command: terraform plan

  test_cm:
    executor: ansible
    steps:
      - checkout
      - run:
          name: install and init terraform
          working_directory: ./cm/molecule/default/terraform
          command: |
            wget https://releases.hashicorp.com/terraform/0.12.12/terraform_0.12.12_linux_amd64.zip
            unzip terraform_0.12.12_linux_amd64.zip
            ./terraform init
      - run:
          name: build TestInfra (terraform)
          working_directory: ./cm/molecule/default/terraform
          command: |
            ./terraform plan -out build.tfplan
            ./terraform apply -input=false build.tfplan
      - add_ssh_keys:
          fingerprints:
            - "80:5f:c6:dc:47:20:80:1f:7b:bf:63:f2:bc:b7:24:a1"
      - run:
          name: running molecule tests
          working_directory: ./cm
          command: molecule test
      - run:
          name: cleanup TestInfra (terraform)
          working_directory: ./cm/molecule/default/terraform
          command: |
           ./terraform plan -destroy -out destroy.tfplan
           ./terraform apply -input=false destroy.tfplan
          when: always

  deploy_iac:
    executor: terraform
    steps:
      - checkout
      - run:
          working_directory: ./iac
          command: ansible-playbook main.yml

  deploy_cm:
    executor: ansible
    steps:
      - checkout
      - run:
          working_directory: ./cm
          command: ansible-playbook main.yml

commands:
  validate_ansible:

